@{
    ViewData["Title"] = "Data Uploader";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container mt-5">
    <h2>@ViewData["Title"]</h2>

    <button class="btn btn-primary mt-3" onclick="startExport()">Start Export</button>


    <!-- USER DETAILS -->
    <div class="mt-4 export-section d-none" id="userSection">
        <label>User Details</label>
        <div class="progress">
            <div id="userProgress" class="progress-bar" style="width:0%">0%</div>
        </div>
        <div id="userMsg" class="mt-2"></div>
    </div>

    <!-- DEPARTMENT DETAILS -->
    <div class="mt-4 export-section d-none" id="deptSection">
        <label>Department Details</label>
        <div class="progress">
            <div id="deptProgress" class="progress-bar bg-success" style="width:0%">0%</div>
        </div>
        <div id="deptMsg" class="mt-2"></div>
    </div>

    <!-- PROJECT DETAILS -->
    <div class="mt-4 export-section d-none" id="projSection">
        <label>Project Details</label>
        <div class="progress">
            <div id="projProgress" class="progress-bar bg-warning" style="width:0%">0%</div>
        </div>
        <div id="projMsg" class="mt-2"></div>
    </div>
</div>

<script>
    function startExport() {
        // Hide all sections initially
        $(".export-section").addClass("d-none");

        // Start sequential execution
        exportTask(
            "/Export/ExportUsers",
            "userProgress",
            "userMsg",
            "userSection",
            function () {
                exportTask(
                    "/Export/ExportDepartments",
                    "deptProgress",
                    "deptMsg",
                    "deptSection",
                    function () {
                        exportTask(
                            "/Export/ExportProjects",
                            "projProgress",
                            "projMsg",
                            "projSection"
                        );
                    }
                );
            }
        );
    }

        function exportTask(url, progressId, messageId, sectionId, onComplete) {

        // Hide all sections
        $(".export-section").addClass("d-none");

        // Show current section
        $("#" + sectionId).removeClass("d-none");

        let bar = $("#" + progressId);
        let msg = $("#" + messageId);

        // Reset progress bar
        bar.removeClass("bg-danger bg-success")
           .css("width", "25%")
           .text("25%");

        msg.html("");

        // Add 10-second delay before AJAX
        setTimeout(function () {
            $.ajax({
                url: url,
                type: "POST",
                success: function (res) {
                    if (res.success) {
                        bar.css("width", "100%")
                           .text("100%")
                           .addClass("bg-success");

                        msg.html(`<div class="alert alert-success">${res.message}</div>`);

                        // Move to next step
                        if (onComplete) onComplete();
                    } else {
                        bar.addClass("bg-danger");
                        msg.html(`<div class="alert alert-danger">${res.message}</div>`);
                    }
                },
                error: function () {
                    bar.addClass("bg-danger");
                    msg.html(`<div class="alert alert-danger">Unexpected error occurred</div>`);
                }
            });
        }, 10000); // 10000ms = 10 seconds
    }

</script>
